<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src https://fonts.gstatic.com;
        img-src 'self' data: blob:;
        media-src 'self' blob:;
        worker-src 'self' blob:;
        connect-src 'self' https: wss: data:;
    ">
    <title>P2P Streaming Platform</title>
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#0369a1">
    <link rel="shortcut icon" href="favicon/favicon.ico">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ethers.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" type="application/javascript"></script>
    <!-- DOMPurify for security -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js"></script>
    <!-- Streamr Client SDK (Latest Version) -->
    <script src="https://unpkg.com/@streamr/sdk@103.0.0/dist/streamr-sdk.web.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-zinc-900 text-zinc-300 flex justify-center h-screen p-4">

    <div id="main-container" class="w-full h-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-8 items-start pt-12 md:pt-16">
        
        <!-- Video Column -->
        <div id="video-column" class="lg:col-span-5 w-full flex justify-center">
             <div class="w-full max-w-4xl">
                
                <!-- Lobby Page (New) -->
                <div id="lobby-page" class="page active">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-white">Stream Rooms</h1>
                        <p id="lobby-status" class="text-zinc-400 mt-1">Loading available rooms...</p>
                    </div>

                    <!-- Go Live Button -->
                    <div class="flex justify-center mb-10">
                         <button id="go-live-btn-lobby" class="go-live-item stream-item w-full max-w-[220px] flex flex-col items-center justify-center p-4">
                             <div class="mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                                    <path d="M14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                </svg>
                            </div>
                            <h2 class="text-md font-semibold text-white">Go Live</h2>
                        </button>
                    </div>

                    <div id="stream-list-loader" class="text-center py-16">
                        <div class="relative w-24 h-24 mx-auto mb-4">
                            <div class="absolute inset-0 border-4 border-zinc-700 rounded-full"></div>
                            <div class="absolute inset-0 border-t-4 border-blue-500 rounded-full animate-spin"></div>
                            <div class="absolute inset-2 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                        </div>
                        <p class="text-zinc-400">Searching for rooms...</p>
                    </div>

                    <div id="stream-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
                        <!-- Stream items will be dynamically added here -->
                    </div>
                </div>

                <!-- Broadcast Settings Page -->
                <div id="settings-page" class="page">
                     <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-white">Broadcast Settings</h1>
                        <p class="text-zinc-400 mt-1">Fine-tune your stream for the best performance.</p>
                    </div>
                    <div class="bg-zinc-800 border border-zinc-700 rounded-xl p-6 md:p-8 space-y-4 divide-y divide-zinc-700/50 text-left max-w-md mx-auto">
                        <div class="pt-2">
                            <h3 class="text-sm font-medium text-zinc-300 mb-2">Room Name</h3>
                            <input type="text" id="roomNameInput" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg p-2 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter a name for your room (max 30 chars)..." maxlength="30">
                        </div>
                        <div class="pt-2">
                            <h3 class="text-sm font-medium text-zinc-300 mb-2">Source</h3>
                            <div class="grid grid-cols-2 gap-2 rounded-lg bg-zinc-700 p-1">
                                <label class="text-center text-sm py-2 rounded-md cursor-pointer transition-colors bg-zinc-600 text-white" for="source-camera">Camera</label>
                                <input type="radio" name="broadcast-source" id="source-camera" value="camera" class="sr-only" checked>
                                <label class="text-center text-sm py-2 rounded-md cursor-pointer transition-colors hover:bg-zinc-600/50" for="source-screen">Screen</label>
                                <input type="radio" name="broadcast-source" id="source-screen" value="screen" class="sr-only">
                            </div>
                        </div>
                        <div id="input-devices-group" class="pt-4 space-y-4">
                            <h3 class="text-sm font-medium text-zinc-300">Input Devices</h3>
                            <div>
                                <label for="videoSourceSelect" class="block mb-2 text-sm font-medium text-zinc-400">Camera</label>
                                <select id="videoSourceSelect" class="bg-zinc-700 border border-zinc-600 text-white text-sm rounded-lg focus:ring-zinc-500 focus:border-zinc-500 block w-full p-2.5 disabled:opacity-50" disabled></select>
                            </div>
                            <div>
                                <label for="audioSourceSelect" class="block mb-2 text-sm font-medium text-zinc-400">Microphone</label>
                                <select id="audioSourceSelect" class="bg-zinc-700 border border-zinc-600 text-white text-sm rounded-lg focus:ring-zinc-500 focus:border-zinc-500 block w-full p-2.5 disabled:opacity-50" disabled></select>
                                <canvas id="audio-meter-canvas" width="300" height="10" class="mt-2 w-full h-2 bg-zinc-700 rounded-full"></canvas>
                            </div>
                        </div>
                        <div id="video-quality-group" class="pt-4 space-y-4">
                            <h3 class="text-sm font-medium text-zinc-300">Video Quality</h3>
                            <div id="resolution-setting">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="resolutionSlider" class="text-sm font-medium text-zinc-400">Resolution</label>
                                    <span id="resolutionValue" class="text-sm font-mono text-zinc-400">720p</span>
                                </div>
                                <input id="resolutionSlider" type="range" min="0" max="2" value="1" step="1" class="disabled:opacity-50">
                            </div>
                             <div id="framerate-setting">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="framerateSlider" class="text-sm font-medium text-zinc-400">Frame Rate</label>
                                    <span id="framerateValue" class="text-sm font-mono text-zinc-400">30 fps</span>
                                </div>
                                <input id="framerateSlider" type="range" min="15" max="60" value="30" step="1" class="disabled:opacity-50">
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label for="bitrateSlider" class="text-sm font-medium text-zinc-400">Video Bitrate</label>
                                    <span id="bitrateValue" class="text-sm font-mono text-zinc-400">2.0 Mbps</span>
                                </div>
                                <input id="bitrateSlider" type="range" min="500000" max="12000000" value="2000000" step="100000" class="disabled:opacity-50">
                            </div>
                        </div>
                        <div id="audio-quality-group" class="pt-4 space-y-4">
                             <h3 class="text-sm font-medium text-zinc-300">Audio Quality</h3>
                             <div>
                                <div class="flex justify-between items-center mb-2">
                                     <label for="audioQualitySlider" class="text-sm font-medium text-zinc-400">Quality</label>
                                     <span id="audioQualityValue" class="text-sm font-mono text-zinc-400">Balanced (64 Kb)</span>
                                </div>
                                <input id="audioQualitySlider" type="range" min="0" max="3" value="1" step="1" class="disabled:opacity-50">
                            </div>
                        </div>
                        <details id="advanced-settings-group" class="pt-2">
                            <summary class="text-sm font-medium text-zinc-300">
                                <span>Advanced Settings</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 summary-arrow text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </summary>
                            <div class="space-y-4 pt-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="tooltip-container">
                                            <label for="performanceSlider" class="text-sm font-medium text-zinc-400">Performance</label>
                                            <div class="tooltip-icon">
                                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                            </div>
                                            <span class="tooltip-text !w-56 !-ml-28">Lowest Latency is faster for real-time interaction. Best Quality prioritizes a clearer image, which might add a small delay.</span>
                                        </div>
                                        <span id="performanceValue" class="text-sm font-mono text-zinc-400">Best Quality</span>
                                    </div>
                                    <input id="performanceSlider" type="range" min="0" max="1" value="1" step="1" class="disabled:opacity-50">
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="tooltip-container">
                                            <label for="keyframeIntervalSlider" class="text-sm font-medium text-zinc-400">Key Frame Interval</label>
                                             <div class="tooltip-icon">
                                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                            </div>
                                            <span class="tooltip-text !w-56 !-ml-28">How often a full video frame is sent. Shorter intervals can improve stream recovery on unstable connections but use more data.</span>
                                        </div>
                                        <span id="keyframeIntervalValue" class="text-sm font-mono text-zinc-400">2.0 s</span>
                                    </div>
                                    <input id="keyframeIntervalSlider" type="range" min="1000" max="10000" value="2000" step="500" class="disabled:opacity-50">
                                </div>
                            </div>
                        </details>
                    </div>
                    <p id="settings-status" class="text-center text-red-400 text-sm mt-4 min-h-[1.25rem]"></p>
                    <div class="mt-4 flex justify-center gap-4">
                        <button id="back-to-lobby-btn-settings" class="bg-zinc-600 hover:bg-zinc-500 text-white font-bold py-2 px-5 rounded-lg transition-colors">Back</button>
                        <button id="start-broadcast-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">Start Broadcasting</button>
                    </div>
                </div>

                <!-- Broadcast Page -->
                <div id="broadcast-page" class="page">
                     <h1 class="text-2xl font-bold text-white text-center mb-1">Broadcasting</h1>
                     <div id="broadcast-room-info" class="text-center text-zinc-400 mb-4 flex items-center justify-center gap-2">
                        <span id="roomNameOnBroadcastPage" class="font-semibold"></span>
                        <button id="shareBtnBroadcast" title="Copy room link" class="text-zinc-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                        </button>
                     </div>
                     <div class="bg-zinc-800 border border-zinc-700 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between text-zinc-400 text-sm mb-4">
                            <!-- Left side: User ID -->
                            <div class="flex items-center gap-2">
                                 <span id="broadcaster-user-id" class="text-xs truncate"></span>
                                 <button id="nicknameBtnBroadcast" title="Set Nickname" class="text-zinc-400 hover:text-white transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <!-- Right side: Status -->
                            <div class="flex items-center gap-4">
                                <div id="broadcast-status">...</div>
                                <div id="viewer-count-broadcaster" class="flex items-center gap-1 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                    <span id="viewer-count-broadcaster-value">0</span>
                                </div>
                            </div>
                        </div>
                        <video id="localVideo" autoplay playsinline muted class="w-full h-auto bg-zinc-900 rounded-md camera-view"></video>
                    </div>
                    <div class="w-full flex justify-center">
                        <button id="back-to-lobby-btn" class="mt-8 bg-zinc-600 hover:bg-zinc-500 text-white font-bold py-2 px-5 rounded-lg transition-colors">Stop and Go Back</button>
                    </div>
                </div>

                <!-- Watch Page -->
                <div id="watch-page" class="page">
                    <!-- Player Header: Contains all metadata about the stream -->
                    <div id="player-header" class="text-center mb-6">
                        <div class="text-2xl font-bold text-white flex items-center justify-center gap-2">
                             <h1 id="roomNameOnWatchPage">Watching Stream</h1>
                             <button id="shareBtnWatch" title="Copy room link" class="text-zinc-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                             </button>
                        </div>
                        <div id="broadcaster-info-on-watch-page" class="text-zinc-400 text-sm mt-2 hidden flex items-center justify-center gap-2">
                             <span id="broadcaster-display-name"></span>
                             <div class="tooltip-container">
                                <button id="tipBtn" class="ml-2 bg-amber-500 hover:bg-amber-600 text-white font-bold py-1 px-2 rounded-full text-xs transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-amber-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-1.134 0V7.418zM12.25 10a2.5 2.5 0 01-2.25 2.45V15a.75.75 0 01-1.5 0v-2.55a2.5 2.5 0 01-2.25-2.45V9a.75.75 0 011.5 0v1h.75a.75.75 0 010 1.5H9.5v-1a.75.75 0 011.5 0v1h.75a.75.75 0 010 1.5H11v-1a.75.75 0 011.5 0V10z" />
                                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-1.5a6.5 6.5 0 110-13 6.5 6.5 0 010 13z" clip-rule="evenodd" />
                                    </svg>
                                    <span>Tip</span>
                                </button>
                                <span class="tooltip-text !w-64 !-ml-32">Para enviar uma gorjeta, tanto vocÃª como o streamer tÃªm de estar ligados a uma carteira.</span>
                             </div>
                        </div>
                        <div class="flex items-center justify-center gap-4 mt-1 text-zinc-400 text-sm">
                            <div id="watch-status">...</div>
                            <div id="viewer-count-watcher" class="flex items-center gap-1 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                <span id="viewer-count-watcher-value">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Player Container: Wraps the video canvas and its overlay controls -->
                    <div id="player-container" class="bg-zinc-800 border border-zinc-700 p-4 rounded-xl shadow-lg">
                        <div class="relative group">
                            <div id="canvas-wrapper" class="w-full bg-zinc-900 rounded-md overflow-hidden">
                                <canvas id="remoteCanvas" class="w-full h-full block"></canvas>
                            </div>
                            <div class="absolute top-2 right-2 bg-zinc-900/50 backdrop-blur-sm rounded-full p-2">
                                <span id="statusDot" class="status-dot dot-red" title="Disconnected"></span>
                            </div>
                             <div class="absolute bottom-4 left-4 right-4 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <button id="back-to-lobby-btn" class="p-2 rounded-full bg-zinc-900/50 hover:bg-zinc-700/70 transition-colors" title="Stop and Go Back">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button id="playPauseBtn" class="p-2 rounded-full bg-zinc-900/50 hover:bg-zinc-700/70 transition-colors" title="Play/Pause">
                                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white hidden" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="flex items-center gap-2 w-24">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-zinc-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" />
                                    </svg>
                                    <input id="volume-slider" type="range" min="0" max="100" value="100" class="w-full">
                                </div>
                                 <button id="fullscreen-btn" class="p-2 rounded-full bg-zinc-900/50 hover:bg-zinc-700/70 transition-colors" title="Fullscreen">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-5h-4m0 0v4m0-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5h-4m0 0v-4m0 4l-5-5" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Player Footer: Contains external controls like the buffer slider -->
                    <div id="player-footer" class="mt-4 flex flex-col items-center gap-2 px-2">
                         <button id="toggle-latency-controls-btn" class="p-2 rounded-full hover:bg-zinc-700 transition-colors">
                            <svg id="toggle-latency-arrow" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-zinc-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="latency-controls-collapsible" class="w-full hidden">
                            <div class="space-y-2">
                                <div id="latency-controls">
                                    <label for="bufferSlider" class="text-sm font-medium text-zinc-300 text-center block mb-2">Playback Buffer</label>
                                    <div id="buffer-slider-container" class="flex items-center gap-3">
                                        <span class="text-xs text-zinc-400">Fastest</span>
                                        <input id="bufferSlider" type="range" min="150" max="3000" value="150" step="50">
                                        <span class="text-xs text-zinc-400">Smoothest</span>
                                    </div>
                                    <span id="bufferValue" class="text-sm font-mono text-zinc-400 text-center block mt-1">150 ms (Lowest Latency)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Column -->
        <div id="chat-container" class="lg:col-span-2 w-full hidden">
            <div class="bg-zinc-800 border border-zinc-700 w-full rounded-xl shadow-2xl flex flex-col">
                <div class="p-4 flex flex-col flex-1 h-0">
                    <div id="chat-header" class="flex justify-between items-center pb-2 mb-2 border-b border-zinc-700">
                        <span id="chat-user-id" class="text-xs text-zinc-400 truncate"></span>
                        <button id="nicknameBtn" title="Set Nickname" class="text-zinc-400 hover:text-white transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex-1 mb-4 overflow-y-auto p-2 rounded-lg bg-zinc-900 flex flex-col" id="messagesContainer"></div>
                    <div class="relative flex items-center mt-auto">
                        <button id="emojiBtn" class="emoji-button">ðŸ˜€</button>
                        <div id="emojiPicker" class="emoji-picker overflow-y-auto max-h-64"></div>
                        <textarea id="messageInput" rows="1" placeholder="Write your message..." class="flex-1 py-2 px-4 pr-16 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                        <button id="sendBtn" class="send-button absolute right-2 top-1/2 -translate-y-1/2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-zinc-900 flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-8 max-w-sm w-full text-zinc-300 text-center shadow-2xl">
            <div id="loginContent">
                <h2 class="text-2xl font-bold mb-4 text-white">Welcome to the Decentralized Streaming Platform</h2>
                <p class="mb-6">For a persistent identity, connect your wallet. Otherwise, you can continue as a guest.</p>
                <button id="connectWalletBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mb-4 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    Connect Wallet
                </button>
                <button id="guestBtn" class="w-full bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Continue as Guest
                </button>
            </div>
            <div id="loadingContent" class="hidden">
                 <div class="flex justify-center items-center mb-4">
                    <div class="spinner"></div>
                </div>
                <p class="text-lg">Connecting...</p>
                <p id="loading-instructions" class="text-sm text-zinc-400 mt-2"></p>
            </div>
        </div>
    </div>
    
    <!-- Nickname Modal -->
    <div id="nicknameModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-zinc-800 rounded-lg p-8 max-w-sm w-full text-zinc-300 border border-zinc-700">
            <h2 class="text-2xl font-bold mb-4 text-white">Set Your Nickname</h2>
            <p class="mb-4">This will be displayed to other users in the chat.</p>
            <input type="text" id="nicknameInput" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg p-2 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your nickname..." maxlength="20">
            
            <div class="flex items-center gap-4">
                <button id="saveNicknameBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" title="Save Nickname">
                    Save
                </button>
                <button id="resetNicknameBtn" class="w-full bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" title="Reset to ID">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Tip Modal -->
    <div id="tipModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-zinc-800 rounded-lg p-8 max-w-sm w-full text-zinc-300 border border-zinc-700">
            <div id="tip-initial-view">
                <h2 class="text-2xl font-bold mb-2 text-white">Send a Tip</h2>
                <p class="mb-4">Show your support for <span id="tip-recipient-name" class="font-semibold">the broadcaster</span>!</p>
                <div class="mb-4 space-y-3">
                    <div>
                        <label for="tipTokenSelect" class="block text-sm font-medium text-zinc-400 mb-1">Token</label>
                        <select id="tipTokenSelect" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label for="tipAmountInput" id="tipAmountLabel" class="block text-sm font-medium text-zinc-400 mb-1">Amount</label>
                        <input type="number" id="tipAmountInput" step="0.001" min="0" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.01">
                    </div>
                </div>
                <p id="tip-error-msg" class="text-red-400 text-sm mb-4 min-h-[1.25rem]"></p>
                <div class="flex items-center gap-4">
                    <button id="cancelTipBtn" class="w-full bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button id="sendTipBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Send Tip
                    </button>
                </div>
            </div>
            <div id="tip-loading-view" class="hidden text-center">
                <div class="flex justify-center items-center mb-4">
                    <div class="spinner"></div>
                </div>
                <p class="text-lg">Processing Transaction...</p>
                <p class="text-sm text-zinc-400 mt-2">Please confirm in your wallet.</p>
            </div>
            <div id="tip-success-view" class="hidden text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-400 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <h2 class="text-2xl font-bold mb-2 text-white">Success!</h2>
                <p class="mb-4">Your tip has been sent.</p>
                <a id="tip-etherscan-link" href="#" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline mb-4 inline-block">View on Explorer</a>
                <button id="closeTipSuccessBtn" class="w-full bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        Link copied to clipboard!
    </div>

    <!-- Changed script to type="module" and pointed to main.js -->
    <script type="module" src="main.js" defer></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                }).catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            });
        }   
    </script>

</body>
</html>
